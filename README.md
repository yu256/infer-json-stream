# infer-json-stream

`infer-json-stream`は、**大量の**JSONデータからTypeScriptの型定義を生成するためのコマンドラインツールです。

## 入力JSONの制約

入力JSONファイルは、以下の構造を持つJSONオブジェクトの配列である必要があります。`tag`と`content`オプションでフィールド名を指定しない場合、デフォルトで`type`と`content`が使用されます。

```json
[
  {
    "type": "string",
    "content": "string"
  },
  {
    "type": "string",
    "content": "string"
  }
]
```

各オブジェクトの`type`フィールドはイベントの種類を、`content`フィールドはイベントのペイロード（JSON文字列）を表します。

## 使い方

```bash
cargo run -- -i <input_json_file> -o <output_ts_file> -r <root_type_name>
```

### オプション

- `-i`, `--input`：入力JSONファイルのパス（デフォルト: `input.json`）
- `-o`, `--output`：出力TypeScriptファイルのパス（デフォルト: `output.ts`）
- `-r`, `--root_name`：生成されるルート型定義の名前（デフォルト: `Events`）
- `--tag_field_name`：イベントのタグ（型）を表すJSONフィールド名（デフォルト: `type`）
- `--content_field_name`：イベントのペイロードを表すJSONフィールド名（デフォルト: `content`）

## 型推論

`infer-types`は、入力されたJSONデータからTypeScriptの型を推論する際に、以下のルールに従います。

### 1. 個々のJSON値の型推論

-   **基本的な型**: `null`, `true`/`false` (真偽値), `123` (数値), `"hello"` (文字列) は、それぞれTypeScriptの`null`, `boolean`, `number`, `string`として推論されます。
-   **配列**: 
    -   もし配列のすべての要素が`string`, `number`, `boolean`, `null`のような基本的な型であれば、それらの型の「タプル」として推論を試みます。例えば、`[1, "hello", true]`は`[number, string, boolean]`のように推論されます。
    -   それ以外の複雑な要素（オブジェクトや別の配列）が含まれる場合、またはタプルとして推論できない場合は、配列内のすべての要素の型を「結合」して、`Array<要素の型>`として推論します。例えば、`[1, "hello"]`は`Array<number | string>`のように推論されます。
-   **オブジェクト**: オブジェクトの各プロパティ（キーと値のペア）について、その値の型を再帰的に推論します。最初はすべてのプロパティが必須として扱われます。

### 2. 複数の型を結合するルール

複数のJSONデータ（例えば、異なるイベントのペイロード）から共通の型を生成するために、`infer-types`は推論された型を「結合」します。この結合ルールにより、より汎用的な型が導き出されます。

-   **`any`型**: 結合する型の中に`any`があれば、結果は`any`になります。
-   **プリミティブ型の結合**: 
    -   異なる基本的な型（例: `string`と`number`）を結合すると、それらの型のユニオン型（`string | number`）になります。
    -   既存のユニオン型に新しい基本的な型を結合する場合、その型がユニオンに含まれていなければ追加されます。
-   **配列の結合**: 複数の配列型を結合する場合、それぞれの配列の「要素の型」を結合した新しい配列型になります。
-   **オブジェクトの結合**: 複数のオブジェクト型を結合する場合、以下のルールが適用されます。
    -   **共通のプロパティ**: 両方のオブジェクトに存在するプロパティは、その値の型を結合します。どちらか一方のオブジェクトでそのプロパティが省略可能（存在しない）であれば、結果の型でもそのプロパティは省略可能になります。
    -   **片方にしかないプロパティ**: 片方のオブジェクトにしか存在しないプロパティは、結果の型では省略可能なプロパティとして扱われます。
-   **`null`との結合**: オブジェクトや配列が`null`と結合される場合、その型は`型 | null`（Nullable型）として推論されます。

## 開発

### テストの実行

```bash
cargo test
```

### フォーマット

```bash
cargo fmt
```